<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<title></title>
</head>
<body>

<div style="width:602px;height:603px">
<img src="board.png" id="board"/>
</div>

<script type="text/javascript">
$(document).ready(function(){

//黑子是叉，白子是圈
var gameboard = new Array();

var pieces = new Array("x", "o");
var currentplayer = pieces[0];
var moves = new Array(Number(0), Number(0));
var validboard = new Array(new Array(), new Array());

var elementName = new Array("black", "white");
var photoScource = new Array("black.png", "white.png", "black2.png", "white2.png");

for (var i=0;i<8;i++)
{
  gameboard[i] = new Array();
  validboard[0][i] = new Array();
  validboard[1][i] = new Array();
  for (var j=0; j<8; j++)
  {
    gameboard[i][j] = "_";
    validboard[0][i][j] = "_";
    validboard[1][i][j] = "_";
  }
}


var oldboard = new Array();
for (var i=0;i<8;i++)
{
  oldboard[i] = new Array();
}

/*
  prepare the new board for the new game
*/
function prepareNewBoard()
{
  for (var i=0;i<8;i++){
    for (var j=0; j<8; j++){
      gameboard[i][j] = "_";
    }
  }

  update_old();

  gameboard[3][3] = pieces[1];
  gameboard[3][4] = pieces[0];
  gameboard[4][3] = pieces[0];
  gameboard[4][4] = pieces[1];

  validate();
}

/*
  let the oldboard updated with the gameboard
*/
function update_old()
{
  for (var i=0;i<8;i++){
    for (var j=0; j<8; j++){
      oldboard[i][j]=gameboard[i][j];
    }
  }
}

/*
  clean the old element
*/
function cleanboard()
{
  for (var i=0;i<8;i++)
  {
    for (var j=0; j<8; j++)
    {
      for (var k=0; k<2; k++)
      {
        var s = document.getElementById(elementName[k]+i*8+j);
        if (s!=null)
        {
          s.parentNode.removeChild(s);
        }
      }
    }
  }
}


/*
  display all the pieces and let the valid possible moves to be seen when hovered on
*/
function display()
{
  var up = 0;
  var left = 0;
  var board = document.getElementById("board");
  board.style.cssText = "top:"+up+"px;position:absolute;left:"+left+"px;";

  //Added 2016-9-20 starts
  cleanboard();
  update_old();
  //Added 2016-9-20 ends

  for (var i=0;i<8;i++)
  {
    for (var j=0; j<8; j++)
    {
      for (var k=0; k<2; k++)
      {
        if (gameboard[i][j] == pieces[k])
        {
          var xcoor = left+41+j*65;
          var ycoor = up+41+i*65;
          var container = document.createElement("div");
          container.id = elementName[k]+i*8+j;
          container.style.cssText = "width:65px;height:65px;top:"+ycoor+"px;position:absolute;left:"+xcoor+"px;";
          var img = document.createElement("img");
          img.src = photoScource[k];
          container.appendChild(img);
          document.body.appendChild(container);
        }

        // here we want to add the possible moves to be elements
        if (validboard[k][i][j] == pieces[k])
        {
          var xcoor = left+41+j*65;
          var ycoor = up+41+i*65;
          var container = document.createElement("div");
          container.id = elementName[k]+i*8+j;
          container.style.cssText = "width:65px;height:65px;top:"+ycoor+"px;position:absolute;left:"+xcoor+"px;";
          container.className = "hover"+k;
          var img = document.createElement("img");
          img.src = photoScource[k+2];
          container.appendChild(img);
          document.body.appendChild(container);
        }
      }
    }
  }
}

function handleEvent()
{
  for (var k=0; k<2; k++)
  {
    $("div.hover"+k).children("img").hide();
    if (currentplayer == pieces[k])
    {
      $("div.hover"+k).mouseenter(function(){
          $(this).children("img").show();
      });
      $("div.hover"+k).mouseleave(function(){
          $(this).children("img").hide();
      });
    }
  }
}

/*
  Change the pieces in certain directions between target point and end point.
  The @current_piece is the current color the target point, or assumed color of it during idnetifying whether the point will a valid move.
  The @change is a boolean. True if it is a actual move, false if it is an assumed move.
*/
function change_inside(target_x, target_y, end_x, end_y, current_piece, change)
{
  var i = Number(target_x);
  var j = Number(target_y);
  var listx = new Array(); var listy = new Array(); var num = Number(0);
  var found = Boolean(false);

  while (!found && (i != end_x || j != end_y))
  {
    if (end_x - i != 0)
    {
      i = i + (end_x - i)/Math.abs(end_x - i);
    }
    if (end_y - j != 0)
    {
      j = j + (end_y - j)/Math.abs(end_y - j);
    }

    if (gameboard[i][j] == "_")
    {
      return false;
    }
    else if (gameboard[i][j] == current_piece)
    {
      found = true;
      break;
    }

    listx[num] = i;
    listy[num] = j;
    num++;
  }

  if (num == 0)
  {
    return false;
  }
  else if (change == true)
  {
    for (var n=0; n<num; n++)
    {
      gameboard[listx[n]][listy[n]] = current_piece;
    }
  }
  return true;
}

/*
  Expand from the target point in 8 directions.
  The @current_piece is the current color the target point, or assumed color of it during idnetifying whether the point will a valid move.
  The @change is a boolean. True if it is a actual move, false if it is an assumed move.
*/
function expand(target_x, target_y, current_piece, change)
{
  var enable = Boolean(false);
  var up = Number(Math.min(target_x, target_y));
  var down = Number(Math.min(7 - target_x, 7 - target_y));
  var left = Number(Math.min(target_x, 7 - target_y));
  var right = Number(Math.min(7 - target_x, target_y));

  if (change_inside(target_x, target_y, 0, target_y, current_piece, change))
    enable = true;
  if (change_inside(target_x, target_y, 7, target_y, current_piece, change))
    enable = true;
  if (change_inside(target_x, target_y, target_x, 0, current_piece, change))
    enable = true;
  if (change_inside(target_x, target_y, target_x, 7, current_piece, change))
    enable = true;
  if (change_inside(target_x, target_y, target_x-up, target_y-up, current_piece, change))
    enable = true;
  if (change_inside(target_x, target_y, target_x-left, target_y+left, current_piece, change))
    enable = true;
  if (change_inside(target_x, target_y, target_x+down, target_y+down, current_piece, change))
    enable = true;
  if (change_inside(target_x, target_y, target_x+right, target_y-right, current_piece, change))
    enable = true;

  if (enable == true)
  {
    return true;
  }
  else
  {
    return false;
  }

}

/*
  mark the valid possible moves on the xboard and oboard;
*/
function validate()
{
  moves[0] = Number(0);
  moves[1] = Number(0);
  for ( var i = 0; i<8; i++)
  {
    for (var j = 0; j<8; j++)
    {
      for (var k = 0; k<2 ;k++)
      {
        validboard[k][i][j] = "_";
        if (gameboard[i][j] == "_")
        {
          if (expand(i, j, pieces[k], false))
          {
            validboard[k][i][j] = pieces[k];
            moves[k]++;
          }
        }
      }
    }
  }
}

function update(x, y)
{
  gameboard[x][y] = currentplayer;
  //update the gameboard
  expand(x, y, currentplayer, true)

  //update the xboard, oboard, xmove and omove;
  validate();

  if (currentplayer == pieces[0])
  {
    if (moves[1] != 0)
    {
      currentplayer = pieces[1];
    }
  }
  else if (currentplayer == pieces[1])
  {
    if (moves[0] != 0)
    {
      currentplayer = pieces[0];
    }
  }

  display();
  handleEvent();
}

prepareNewBoard();
display();
update(Number(3),Number(2));
update(Number(2),Number(2));
update(Number(2),Number(3));
update(Number(4),Number(2));
update(Number(5),Number(2));
update(Number(6),Number(2));
update(Number(5),Number(1));
update(Number(5),Number(0));
update(Number(7),Number(2));
update(Number(5),Number(3));
update(Number(6),Number(3));
update(Number(5),Number(4));
update(Number(7),Number(3));
update(Number(7),Number(1));
update(Number(7),Number(0));

});
</script>

</body>
</html>
